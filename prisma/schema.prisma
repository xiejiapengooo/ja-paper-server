generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum PaperLevel {
  N1
  N2
  N3
  N4
  N5
}

enum SectionType {
  VOCAB_GRAMMAR // 言語知識（文字・語彙・文法）
  READING // 読解
  LISTENING // 聴解
}

enum QuestionType {
  // 汉字读法
  CHINESE_PRONUNCIATION
  // 汉字书写
  CHINESE_WRITING
  // 词语构成
  WORD_COMPOSITION
  // 上下关系
  CONTEXT
  // 近义替换
  SYNONYM_SUBSTITUTION
  // 用法
  USAGE
  // 句子语法1（语法形式的判断）
  SENTENCE_GRAMMAR_1
  // 句子语法2（句子的组织）
  SENTENCE_GRAMMAR_2
  // 文章语法
  ARTICLE_GRAMMAR
  // 内容理解（短篇）
  CONTENT_COMPREHENSION_SHORT
  // 内容理解（中篇）
  CONTENT_COMPREHENSION_MIDDLE
  // 内容理解（长篇）
  CONTENT_COMPREHENSION_LONG
  // 综合理解
  SYNTHETICAL_COMPREHENSION_READ
  // 论点理解（中篇）
  THESIS_COMPREHENSION
  // 信息检索
  INFORMATION_RETRIEVAL
  // 问题理解
  QUESTION_COMPREHENSION
  // 重点理解
  EMPHASIS_COMPREHENSION
  // 概要理解
  OUTLINE_COMPREHENSION
  // 语言表达
  LANGUAGE_EXPRESSION
  // 即时应答
  INSTANT_RESPONSE
  // 综合理解
  SYNTHETICAL_COMPREHENSION_LISTEN
}

enum AnswerType {
  SINGLE_CHOICE // 单选题
  MULTI_CHOICE // 多选题
}

enum CertificateType {
  REFRESH_TOKEN
  PASSWORD_RESET
  REGISTER
}

enum UserStatus {
  ACTIVED
  PENDING
  DISABLED
}

enum PaperFileType {
  AUDIO
  VIDEO
  IMAGE
}

model User {
  id           String         @id @default(cuid())
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  deletedAt    DateTime?
  email        String         @unique
  name         String?
  role         UserRole
  status       UserStatus
  password     String
  UserQuestion UserQuestion[]
}

model Certificate {
  id        String          @id @default(cuid())
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  expiredAt DateTime
  usedAt    DateTime?
  userAgent String          @db.Text
  content   String          @unique @db.Text
  type      CertificateType
  relatedId String?

  @@index([relatedId, type])
}

model UserQuestion {
  id           String        @id @default(cuid())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId   String
  question     PaperQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  lastAnswerAt DateTime
  answer       String        @db.Text
  note         String?       @db.Text

  @@unique([userId, questionId])
}

model Paper {
  id          String     @id @default(cuid())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  level       PaperLevel
  year        Int
  month       Int
  title       String     @db.VarChar(255)
  description String?    @db.Text

  sections  PaperSection[]
  parts     PaperPart[]
  questions PaperQuestion[]

  @@index([level, year, month])
}

model PaperPart {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  title          String
  duration       Int
  listeningAudio String?
  order          Int

  paperId String
  paper   Paper  @relation(fields: [paperId], references: [id], onDelete: Cascade)

  sections  PaperSection[]
  questions PaperQuestion[]
}

model PaperSection {
  id                       String      @id @default(cuid())
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt
  partId                   String
  part                     PaperPart   @relation(fields: [partId], references: [id])
  paperId                  String
  paper                    Paper       @relation(fields: [paperId], references: [id], onDelete: Cascade)
  type                     SectionType
  title                    String      @db.VarChar(255)
  order                    Int
  content                  String?     @db.Text
  contentTranslationZhHans String?     @db.Text
  imageContent             String?

  questions PaperQuestion[]
}

model PaperQuestion {
  id                                String       @id @default(cuid())
  createdAt                         DateTime     @default(now())
  updatedAt                         DateTime     @updatedAt
  paperId                           String
  paper                             Paper        @relation(fields: [paperId], references: [id], onDelete: Cascade)
  partId                            String
  part                              PaperPart    @relation(fields: [partId], references: [id])
  sectionId                         String
  section                           PaperSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  type                              QuestionType
  answerType                        AnswerType
  order                             Int
  prompt                            String       @db.Text
  analysis                          String?      @db.Text
  listeningAudio                    String?
  listeningContent                  String?      @db.Text
  listeningContentTranslationZhHans String?      @db.Text

  choices       QuestionChoice[]
  userQuestions UserQuestion[]
}

model QuestionChoice {
  id         String        @id @default(cuid())
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  label      String        @db.VarChar(8)
  text       String        @db.Text
  order      Int
  isCorrect  Boolean
  questionId String
  question   PaperQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}
