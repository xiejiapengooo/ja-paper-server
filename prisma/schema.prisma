generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum PaperLevel {
  N1
  N2
  N3
  N4
  N5
}

enum SectionType {
  VOCAB_GRAMMAR // 言語知識（文字・語彙・文法）
  READING // 読解
  LISTENING // 聴解
}

enum QuestionType {
  SINGLE_CHOICE // 单选题
  MULTI_CHOICE // 多选题
}

enum CertificateType {
  REFRESH_TOKEN
  PASSWORD_RESET
  REGISTER
}

enum UserStatus {
  ACTIVED
  PENDING
  DISABLED
}

enum PaperFileType {
  AUDIO
  VIDEO
  IMAGE
}

model User {
  id           String         @id @default(cuid())
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  deletedAt    DateTime?
  email        String         @unique
  name         String?
  role         UserRole
  status       UserStatus
  password     String
  UserQuestion UserQuestion[]
}

model Certificate {
  id        String          @id @default(cuid())
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  expiredAt DateTime
  usedAt    DateTime?
  userAgent String          @db.Text
  content   String          @unique @db.Text
  type      CertificateType
  relatedId String?

  @@index([relatedId, type])
}

model UserQuestion {
  id           String        @id @default(cuid())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId   String
  question     PaperQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  isFavorite   Boolean
  wrongCount   Int           @default(0)
  lastAnswerAt DateTime?
  chosenIds    String[]
  note         String?       @db.Text

  @@unique([userId, questionId])
}

model Paper {
  id          String     @id @default(cuid())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  level       PaperLevel
  year        Int
  month       Int
  title       String     @db.VarChar(255)
  description String?    @db.Text

  sections PaperSection[]

  @@index([level, year, month])
}

model PaperPart {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  title     String
  duration  Int

  sections PaperSection[]
}

model PaperSection {
  id                       String      @id @default(cuid())
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt
  partId                   String
  part                     PaperPart   @relation(fields: [partId], references: [id])
  paperId                  String
  paper                    Paper       @relation(fields: [paperId], references: [id], onDelete: Cascade)
  type                     SectionType
  title                    String      @db.VarChar(255)
  order                    Int
  content                  String?     @db.Text
  contentTranslationZhHans String?     @db.Text
  imageContent             String?

  questions PaperQuestion[]

  @@index([paperId, order])
  @@index([type])
}

model PaperQuestion {
  id        String       @id @default(cuid())
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  sectionId String
  section   PaperSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  type      QuestionType
  order     Int
  prompt    String       @db.Text
  analysis  String?      @db.Text

  choices       QuestionChoice[]
  userQuestions UserQuestion[]

  @@index([sectionId, order])
  @@index([type])
}

model QuestionChoice {
  id         String        @id @default(cuid())
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  label      String        @db.VarChar(8)
  text       String        @db.Text
  isCorrect  Boolean
  questionId String
  question   PaperQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model PaperFile {
  id        String        @id @default(cuid())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  key       String        @db.Text
  type      PaperFileType
  duration  Int?
}
